services:
  filewhisperer:
    image: filewhisperer:latest
    container_name: filewhisperer
    network_mode: "host"
    command: python3 /app/src/server.py -p 50098 -l debug
    runtime: nvidia
    environment:
       TESSDATA_PREFIX: /app/fixtures/tesseract
       FILE_WHISPERER_OUTPUT_DIR: /files
       NVIDIA_VISIBLE_DEVICES: "0"
       NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      #  LD_LIBRARY_PATH: "/usr/local/cuda/lib64:${LD_LIBRARY_PATH}"
       CUDA_HOME: "/usr/local/cuda"
       # 进程池配置
       FILEWHISPERER_OCR_POOL_ENABLED: "true"
       FILEWHISPERER_OCR_POOL_WORKERS: "10"
       FILEWHISPERER_WORD_POOL_ENABLED: "true"
       FILEWHISPERER_WORD_POOL_WORKERS: "10"
       FILEWHISPERER_PDF_POOL_ENABLED: "true"
       FILEWHISPERER_PDF_POOL_WORKERS: "10"
       FILEWHISPERER_HTML_POOL_ENABLED: "false"
       FILEWHISPERER_HTML_POOL_WORKERS: "1"
       FILEWHISPERER_ARCHIVE_POOL_ENABLED: "false"
       FILEWHISPERER_ARCHIVE_POOL_WORKERS: "1"
       FILEWHISPERER_QRCODE_POOL_ENABLED: "false"
       FILEWHISPERER_QRCODE_POOL_WORKERS: "1"
       FILEWHISPERER_EMAIL_POOL_ENABLED: "false"
       FILEWHISPERER_EMAIL_POOL_WORKERS: "1"
       FILEWHISPERER_URL_POOL_ENABLED: "true"
       FILEWHISPERER_URL_POOL_WORKERS: "10"
    volumes:
      - /mnt/zfs/files:/files
      - /root/.paddlex:/root/.paddlex
    restart: always
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:54324
        tag: docker.filewhisperer
        fluentd-max-retries: "3"
        fluentd-buffer-limit: "100"
        fluentd-retry-wait: "3s"
        fluentd-async: "true"
    deploy:
      resources:
        limits:
          memory: 60G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]